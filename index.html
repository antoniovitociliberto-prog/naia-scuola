<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NAIA 3D - School AI</title>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        
        /* CONTENITORE 3D */
        #scene-container {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            background: radial-gradient(circle at center, #2b2b2b 0%, #000000 100%);
            z-index: 1;
        }

        /* CARICAMENTO */
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #00ffff; font-size: 24px; font-weight: bold; z-index: 50;
            text-shadow: 0 0 10px #00ffff;
        }

        /* INTERFACCIA */
        #ui-layer {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px; display: flex; flex-direction: column; gap: 15px; z-index: 100; align-items: center;
        }

        #status { 
            text-align: center; color: #00ffff; font-weight: bold; background: rgba(0,0,0,0.6); 
            padding: 5px 15px; border-radius: 20px; font-size: 14px;
            text-shadow: 0 0 5px #00ffff;
        }

        /* BARRA DEI CONTROLLI */
        .controls { 
            display: flex; gap: 10px; padding: 10px; 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 30px; backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        button { border: none; cursor: pointer; border-radius: 50%; width: 50px; height: 50px; font-size: 24px; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; }
        button:active { transform: scale(0.9); }
        
        #btn-mic { background: #ff0055; color: #fff; box-shadow: 0 0 15px rgba(255, 0, 85, 0.5); }
        .mic-active { background: red !important; animation: pulseMic 1s infinite; }
        
        #btn-keyboard { background: #333; color: #fff; border: 1px solid #555; }
        #btn-send { background: #00ffff; color: #000; width: 45px; height: 45px; font-size: 18px; margin-left: 5px;}

        /* AREA TESTO NASCOSTA */
        #text-area { display: none; flex: 1; align-items: center; animation: fadeIn 0.3s ease; }
        input { width: 100%; padding: 12px; border-radius: 20px; border: none; background: rgba(0,0,0,0.5); color: white; font-size: 16px; outline: none; }

        @keyframes fadeIn { from { opacity: 0; width: 0; } to { opacity: 1; width: 100%; } }
        @keyframes pulseMic { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <div id="scene-container"></div>
    <div id="loading">STO CREANDO L'AVATAR...</div>

    <div id="ui-layer">
        <div id="status">NAIA SI STA SVEGLIANDO...</div>
        
        <div class="controls" id="controls-bar">
            <button id="btn-keyboard" onclick="toggleKeyboard()">‚å®Ô∏è</button>
            
            <button id="btn-mic" onclick="startDictation()">üé§</button>

            <div id="text-area">
                <input type="text" id="chat-input" placeholder="Chiedi pure..." autocomplete="off">
                <button id="btn-send" onclick="sendToBrain()">‚û§</button>
            </div>
        </div>
    </div>

    <script type="module">
        // 1. IMPORTAZIONE THREE.JS
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // ============================================================
        // CONFIGURAZIONE (Aggiorna NGROK qui!)
        // ============================================================
        const OLLAMA_HOST = 'https://kandra-superpious-kanesha.ngrok-free.dev'; 
        const MODEL_NAME = "naia_school"; 
        const AVATAR_URL = 'https://models.readyplayer.me/697e442c05b43df7aab5a152.glb';

        // Variabili 3D
        let scene, camera, renderer, model, headMesh;
        let mouthOpenIndex = -1;
        let leftEyeIndex = -1, rightEyeIndex = -1;
        
        // Stati
        let isSpeaking = false;
        let blinkTimer = 0;
        const synth = window.speechSynthesis;
        const statusDiv = document.getElementById('status');

        // ============================================================
        // INIZIO MONDO 3D
        // ============================================================
        function init3D() {
            const container = document.getElementById('scene-container');
            
            scene = new THREE.Scene();
            
            // 1. TELECAMERA LONTANA (Per trovarla)
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 1.0, 2.5); // X=0, Y=1m, Z=2.5m (Molto pi√π indietro)

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            container.appendChild(renderer.domElement);

            // 2. LUCI FORTISSIME (Per essere sicuri che si veda)
            const ambientLight = new THREE.AmbientLight(0xffffff, 2.5); // Luce bianca ovunque
            scene.add(ambientLight);
            
            const dirLight = new THREE.DirectionalLight(0xffffff, 2);
            dirLight.position.set(0, 2, 3); // Luce frontale
            scene.add(dirLight);

            // 3. AIUTO VISIVO (Disegna una griglia per terra)
            // Se vedi questa griglia, il 3D funziona.
            const gridHelper = new THREE.GridHelper(10, 10, 0x00ffff, 0x333333);
            scene.add(gridHelper);

            // CARICAMENTO AVATAR
            const loader = new GLTFLoader();
            loader.load(AVATAR_URL, (gltf) => {
                model = gltf.scene;
                scene.add(model);
                
                model.traverse((child) => {
                    if (child.isMesh && child.morphTargetDictionary) {
                        if (child.morphTargetDictionary['mouthOpen'] !== undefined) {
                            headMesh = child;
                            mouthOpenIndex = child.morphTargetDictionary['mouthOpen'];
                        }
                        if (child.morphTargetDictionary['eyesClosed'] !== undefined) {
                            leftEyeIndex = child.morphTargetDictionary['eyesClosed'];
                            rightEyeIndex = child.morphTargetDictionary['eyesClosed'];
                        }
                    }
                });

                // POSIZIONE STANDARD
                model.position.set(0, -1.0, 0); // Piedi a -1 metro (sul pavimento o poco sotto)
                model.scale.set(1, 1, 1); // Scala normale

                document.getElementById('loading').style.display = 'none';
                statusDiv.innerText = "NAIA TROVATA!";

            }, undefined, (e) => {
                console.error(e);
                statusDiv.innerText = "ERRORE CARICAMENTO";
            });

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            animate();
        } 
        // LOOP ANIMAZIONE
        function animate() {
            requestAnimationFrame(animate);

            if (headMesh) {
                const time = Date.now() / 1000;

                // LOGICA BOCCA (LIP SYNC)
                if (isSpeaking) {
                    const talkValue = (Math.sin(time * 15) + 1) / 2; // Onda sinusoidale veloce
                    headMesh.morphTargetInfluences[mouthOpenIndex] = THREE.MathUtils.lerp(headMesh.morphTargetInfluences[mouthOpenIndex], talkValue * 0.7, 0.5);
                } else {
                    headMesh.morphTargetInfluences[mouthOpenIndex] = THREE.MathUtils.lerp(headMesh.morphTargetInfluences[mouthOpenIndex], 0, 0.2);
                }

                // LOGICA OCCHI (BLINK)
                blinkTimer -= 0.015;
                if (blinkTimer <= 0) {
                    triggerBlink();
                    blinkTimer = Math.random() * 4 + 2; // Blink ogni 2-6 secondi
                }
            }
            renderer.render(scene, camera);
        }

        function triggerBlink() {
            if(!headMesh || leftEyeIndex === -1) return;
            let val = 0;
            // Animazione chiusura
            const close = setInterval(() => {
                val += 0.2;
                if (val >= 1) {
                    clearInterval(close);
                    // Animazione apertura
                    const open = setInterval(() => {
                        val -= 0.2;
                        headMesh.morphTargetInfluences[leftEyeIndex] = val;
                        headMesh.morphTargetInfluences[rightEyeIndex] = val;
                        if(val <= 0) clearInterval(open);
                    }, 20);
                }
                headMesh.morphTargetInfluences[leftEyeIndex] = val;
                headMesh.morphTargetInfluences[rightEyeIndex] = val;
            }, 20);
        }

        init3D();

        // ============================================================
        // ESPORTA FUNZIONI PER L'HTML
        // ============================================================
        window.toggleKeyboard = toggleKeyboard;
        window.startDictation = startDictation;
        window.sendToBrain = sendToBrain;

        // UI TOGGLE
        let isKeyboardOpen = false;
        function toggleKeyboard() {
            const textArea = document.getElementById('text-area');
            const btnMic = document.getElementById('btn-mic');
            const inputField = document.getElementById('chat-input');
            const controlsBar = document.getElementById('controls-bar');
            if (!isKeyboardOpen) {
                textArea.style.display = "flex"; btnMic.style.display = "none"; controlsBar.style.width = "90%"; inputField.focus(); isKeyboardOpen = true;
            } else {
                textArea.style.display = "none"; btnMic.style.display = "flex"; controlsBar.style.width = "auto"; isKeyboardOpen = false;
            }
        }

        // ============================================================
        // LOGICA VOCALE & CERVELLO (PRESERVATA)
        // ============================================================

        function speak(text) {
            if (synth.speaking) synth.cancel();
            const allVoices = synth.getVoices();
            const itVoices = allVoices.filter(v => v.lang.includes("it"));
            const femaleVoice = itVoices.find(v => v.name.includes("Google")) || itVoices.find(v => v.name.includes("Elsa")) || itVoices.find(v => v.name.includes("Alice")) || itVoices[0];
            const sentences = text.match(/[^.?!]+[.?!]*/g) || [text];
            playNextSentence(sentences, 0, femaleVoice);
        }

        function playNextSentence(sentences, index, voiceObj) {
            if (index >= sentences.length) {
                statusDiv.innerText = "NAIA PRONTA";
                isSpeaking = false; // FERMA BOCCA
                return;
            }
            const textToSay = sentences[index].trim();
            if(!textToSay) { playNextSentence(sentences, index + 1, voiceObj); return; }
       
            const utterance = new SpeechSynthesisUtterance(textToSay);
            if (voiceObj) utterance.voice = voiceObj;
            utterance.lang = 'it-IT'; utterance.rate = 1.0; utterance.pitch = 1.0;
       
            utterance.onstart = () => {
                isSpeaking = true; // MUOVI BOCCA
                statusDiv.innerText = "NAIA PARLA...";
            };
            utterance.onend = () => { playNextSentence(sentences, index + 1, voiceObj); };
            utterance.onerror = () => { playNextSentence(sentences, index + 1, voiceObj); };
            synth.speak(utterance);
        }

        function startDictation() {
            const btnMic = document.getElementById('btn-mic');
            const inputField = document.getElementById('chat-input');
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { alert("Usa Chrome."); return; }
            const recognition = new SpeechRecognition();
            recognition.lang = 'it-IT';
            recognition.start();
            recognition.onstart = function() { btnMic.classList.add("mic-active"); if(synth.speaking) synth.cancel(); };
            recognition.onend = function() { btnMic.classList.remove("mic-active"); if(inputField.value) sendToBrain(); };
            recognition.onresult = function(e) { inputField.value = e.results[0][0].transcript; };
        }

        async function sendToBrain() {
            const inputField = document.getElementById('chat-input');
            const question = inputField.value;
            if (!question) return;
       
            // IL TUO COPIONE ORIGINALE
            const SYSTEM_INSTRUCTION = `
REGOLE FONDAMENTALI (OBBLIGATORIE):
1. Tu sei NAIA, l'Intelligenza Artificiale avanzata dell'istituto Giovanni Boccardi / Ugo Tiberio di Termoli.
2. Rispondi sempre in ITALIANO.
3. VIETATO USARE FORMATTAZIONE VISIVA: NIENTE ASTERISCHI (*), niente elenchi puntati, niente grassetti, niente titoli (#).
4. Sii BREVE e concisa (massimo 2 frasi).
5. Usa un tono professionale ma amichevole, un po' futuristico.
6. Se non sai una cosa, di' semplicemente che stai ancora imparando.
7. Non inventare fatti strani.
8. SOLO Se ti chiedono "Chi sei", DEVI rispondere che ti chiami NAIA e che sei l'AI della scuola Giovanni Boccardi / Ugo Tiberio di Termoli.
9. DOPO ESSERTI PRESENTATA LA PRIMA VOLTA NON INIZIARE MAI una risposta dicendo "Sono NAIA", rispondi semplicemente alla domanda, vai dritta al punto.
10. NON usare elenchi puntati complessi, USA FRASI DISCORSIVE.
11. USA SOLO I DATI SCRITTI IN QUESTA SEZIONE.
I tuo compito √® accogliere gli ospiti e rispondere alle domande sulla scuola.
SCHEDA INFORMATIVA SCUOLA:
1. DATI IDENTIFICATIVI E AMMINISTRATIVI
denominazione Ufficiale, Istituto di Istruzione Superiore Giovanni Boccardi / Ugo Tiberio
via o indirizzo della sede Centrale, √® Via Alcide De Gasperi, 30, 86039 Termoli (C,B), Molise
pec (Posta Certificata) CBIS01800L@pec.istruzione.it
email Istituzionale CBIS01800L@istruzione.it
sito Web www.iisboccarditiberio.edu.it/
2. STORIA E IDENTIT√Ä
l'istituto nasce dalla fusione di due storiche scuole di Termoli
l'Istituto Tecnico Economico "Giovanni Boccardi" (ex Ragioneria, fondato nel 1959)
l'Istituto Tecnico Tecnologico "Ugo Tiberio" (ex Nautico e Geometri, con il Nautico presente a Termoli fin dal pre-guerra come Scuola Marinara)
certificazioni: L'indirizzo Trasporti e Logistica (Nautico) vanta la Certificazione di Qualit√† ISO 9001 rilasciata da TUV SUD (Certificato n¬∞ 5010014484), fondamentale per il riconoscimento dei titoli marittimi internazionali
3. OFFERTA FORMATIVA DETTAGLIATA
l'istituto offre percorsi diurni (5 anni) e percorsi serali (istruzione per adulti)
per il settore tecnologico Ugo Tiberio abbiamo a disposizione i seguenti corsi di studio:
indirizzo c a i m, Conduzione Apparati e Impianti Marittimi: Formazione per Ufficiali di Macchina
indirizzo c m n, Conduzione del Mezzo Navale: Formazione per Ufficiali di Coperta (Capitani)
indirizzo logistica, Gestione dei trasporti intermodali terra, mare e aria
indirizzo c a t, Costruzioni, Ambiente e Territorio - ex Geometri: Progettazione edilizia, topografia, estimo, sicurezza cantieri, riqualificazione energetica
per il settore economico Giovanni Boccardi abbiamo a disposizione i seguenti corsi di studio:
indirizzo a f m, Amministrazione, Finanza e Marketing: Il corso "classico". Competenze gestionali, fiscali e amministrative
indirizzi s i a, Sistemi Informativi Aziendale: Curvatura informatica dell'AFM (dal 3¬∞ anno). Si studia informatica gestionale, database, coding applicato all'economia
indirizzo r i m, Relazioni Internazionali per il Marketing: Curvatura linguistica dell'AFM (dal 3¬∞ anno). Studio di tre lingue straniere, geopolitica e relazioni internazionali
indirizzo turismo, Percorso specifico per l'impresa turistica. Materie caratterizzanti: Discipline turistiche e aziendali, Arte e Territorio, tre lingue straniere
corsi SERALI Istruzione per Adulti
percorsi abbreviati per lavoratori o chi vuole riprendere gli studi, attivi sia per l'indirizzo Economico che per il Tecnologico, in base al numero di iscritti
4. QUADRO ORARIO DISCIPLINE
1 Opzione caim ufficiali di macchina:
italiano 4 ore settimanali per l'intera durata del percorso di studi
storia 2 ore settimanali per l'intera durata del percorso di studi
inglese 3 ore settimanali per l'intera durata del percorso di studi
matematica 4 ore nel biennio per poi passare a 3 ore negli ultimi 3 anni
diritto ed Economia 2 ore per l'intera durata del percorso di studi
logistica 3 ore di cui 1 in laboratorio per il terzo e quarto anno
elettrotecnica e Automazione 3 ore di cui 2 di laboratorio per gli ultimi 3 anni
scienze della navigazione 3 ore (2 di laboratorio) terzo e quarto anno, 4 ore (3 di laboratorio) il quinto anno
meccanica e Macchine 5 ore per il terzo e il quarto di cui 3 di laboratorio, 8 ore al quinto di cui 5 di laboratorio
scienze motorie 2 ore per tutti gli anni di corso 
religione 1 ora per tutti gli anni di corso 
informatica, Tecniche di rappresentazione grafica, geografia e scienze applicate si fanno nel primo e nel secondo anno 
2 Opzione cmn ufficiali di coperta:
italiano 4 ore settimanali per l'intera durata del percorso di studi 
storia 2 ore settimanali per l'intera durata del percorso di studi
inglese 3 ore settimanali per l'intera durata del percorso di studi 
matematica 4 ore nel biennio per poi passare a 3 ore negli ultimi 3 anni 
diritto ed Economia 2 ore per l'intera durata del percorso di studi 
logistica 3 ore di cui 1 in laboratorio per il terzo e quarto anno 
elettrotecnica e Automazione 3 ore di cui 2 di laboratorio per gli ultimi 3 anni 
meccanica e Macchine 3 ore (2 di laboratorio) terzo e quarto anno, 4 ore (3 di laboratorio) il quinto anno 
scienze della navigazione 5 ore per il terzo e il quarto di cui 3 di laboratorio, 8 ore al quinto di cui 5 di laboratorio 
scienze motorie 2 ore per tutti gli anni di corso 
religione 1 ora per tutti gli anni di corso 
informatica, chimica, fisica, biologia e scienze applicate si fanno nel primo e nel secondo anno 
5. STRUTTURE, LABORATORI E DOTAZIONI TECNICHE
se l'utente chiede "perch√© scegliere questa scuola" o "che laboratori avete", cita questi asset specifici:
planetario, Ristrutturato e riattivato (progetto "Oltre l'Infinito"), utilizzato per lezioni di astronomia e navigazione 
simulatore Navale, Software e hardware professionale per la simulazione di manovre navali (fondamentale per il Nautico)
sala Voga, Ambiente attrezzato per la preparazione fisica al canottaggio 
laboratori Informatici, 5 aule informatizzate (Lab. Economy 2.0, Informatica SIA, Informatica Base) 
altri Laboratori, Chimica, Fisica, Scienze della Navigazione, Logistica 
digital Fabrication, Stampanti 3D e Droni professionali per rilievi topografici e sottomarini 
strutture Sportive, Palestra interna, sala attrezzi ginnici, tavoli da ping-pong, campetti esterni 
sale Conferenze, Due aule magne per eventi e assemblee 
6. PROGETTI E OPPORTUNIT√Ä (EXTRA-CURRICULARI)
erasmus+ (Accreditamento 2022-2027) La scuola √® accreditata come polo di eccellenza per la mobilit√† europea, offre viaggi studio gratuiti e stage all'estero per studenti e docenti
F,S,L, (ex Alternanza Scuola-Lavoro) Collaborazioni con aziende del territorio, studi professionali, compagnie di navigazione, enti turistici e banche per tirocini formativi
certificazioni Linguistiche Preparazione per Cambridge (Inglese), DELF (Francese), DELE (Spagnolo)
centro Sportivo Scolastico Attivit√† pomeridiane (es. canottaggio, sport di squadra)
7. ORGANIGRAMMA E ORARI DI RICEVIMENTO
dirigente Scolastico la professoressa Concetta Cimmino
ricevimento Mar, Mer, Ven (11:00-13:00) su appuntamento
segreteria (Orario Pubblico) Lun-Sab, ore 11:00 - 13:00
collaboratori del Dirigente 
il referente per il settore economico lato Boccardi √® il professore Tommaso Guerrera
la referente per il settore tecnologico lato tiberio e la professoressa Barbara Mammarella
8. DOMANDE FREQUENTI (FAQ) - ISTRUZIONI DI RISPOSTA
Q: Come vedo i voti di mio figlio?
A: Utilizza il Registro Elettronico Spaggiari. Le credenziali vengono fornite dalla segreteria al primo anno. C'√® un link diretto sul sito web della scuola
Q: La scuola √® aperta il pomeriggio?
A: Gli uffici di segreteria no (chiudono alle 14:00, salvo aperture straordinarie). La scuola rimane aperta per i corsi serali e per i progetti pomeridiani programmati
Q: Cosa devo fare per l'iscrizione al primo anno?
A: L'iscrizione si fa online tramite il portale Ministeriale "Unica" (gennaio/febbraio). Ti servir√† il codice meccanografico specifico dell'indirizzo scelto (vedi sezione 1 dei miei dati)
Q: Qual √® il codice meccanografico dell'istituto U Tiberio?
A: CBIS01800L
Q: C'√® il convitto?
A: Non risulta presente un convitto interno gestito direttamente dalla scuola. Gli studenti fuori sede solitamente si appoggiano a strutture private o convitti convenzionati nella zona di Termoli (verificare disponibilit√† aggiornata in segreteria)
Q: Accettate pagamenti in contanti?
A: No. Tutti i pagamenti verso la scuola (tasse, gite, assicurazione) devono passare obbligatoriamente tramite il sistema PagoPA
            `;

            statusDiv.innerText = "PENSO...";
            if(isKeyboardOpen) toggleKeyboard(); // Chiude tastiera per pulizia (facoltativo)

            try {
                const response = await fetch(`${OLLAMA_HOST}/api/generate`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: MODEL_NAME, prompt: question, system: SYSTEM_INSTRUCTION, stream: false, options: { temperature: 0.1, num_predict: 400 } })
                });
                if (!response.ok) throw new Error("Errore Network");
                const data = await response.json();
                
                let cleanText = data.response;
                cleanText = cleanText.replace(/\*/g, "").replace(/[#_`~]/g, "");
                cleanText = cleanText.replace(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gi, m => m.replace(/@/g, " chiocciola ").replace(/\./g, " punto "));
                cleanText = cleanText.replace(/(www\.[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gi, m => m.replace(/\./g, " punto "));
                cleanText = cleanText.replace(/\n/g, ". ").replace(/Sono NAIA,?/gi, "");
                
                inputField.value = "";
                speak(cleanText);

            } catch (error) {
                console.error(error);
                statusDiv.innerText = "ERRORE";
                speak("Ho un problema di connessione.");
            }
        }
        
        document.getElementById("chat-input").addEventListener("keypress", (e) => { if (e.key === "Enter") sendToBrain(); });
    </script>
</body>
</html>

