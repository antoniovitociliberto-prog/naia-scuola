<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NAIA</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/GLTFLoader.js"></script>

<style>
* { box-sizing: border-box; }

body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: #000;
    overflow: hidden;
}

/* AVATAR PROTAGONISTA */
#avatar-stage {
    position: fixed;
    inset: 0;
    background: radial-gradient(circle at top, #eef2ff, #dbeafe);
    z-index: 0;
}

#avatar-canvas {
    width: 100%;
    height: 100%;
    display: block;
}

#avatar-status {
    position: absolute;
    bottom: 150px;
    width: 100%;
    text-align: center;
    font-size: 14px;
    letter-spacing: 2px;
    color: #2563eb;
    text-transform: uppercase;
}

/* CHAT OVERLAY */
#chat-container {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%);
    width: 95%;
    max-width: 900px;
    max-height: 40%;
    overflow-y: auto;
    background: rgba(255,255,255,0.65);
    backdrop-filter: blur(12px);
    border-radius: 20px;
    padding: 20px;
    z-index: 10;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.message {
    padding: 14px 20px;
    border-radius: 18px;
    font-size: 15px;
    line-height: 1.6;
    max-width: 80%;
}

.ai-msg {
    background: white;
    color: #333;
    align-self: flex-start;
}

.user-msg {
    background: #2563eb;
    color: white;
    align-self: flex-end;
}

/* INPUT */
#input-zone {
    position: fixed;
    bottom: 0;
    width: 100%;
    background: white;
    padding: 10px;
    z-index: 20;
}

.input-wrapper {
    max-width: 900px;
    margin: auto;
    display: flex;
    gap: 10px;
}

#chat-input {
    flex: 1;
    padding: 15px 20px;
    border-radius: 30px;
    border: none;
    background: #f3f4f6;
    font-size: 15px;
    outline: none;
}

.icon-btn {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    border: none;
    font-size: 22px;
    cursor: pointer;
}

#btn-mic { background: white; border: 1px solid #ddd; }
#btn-send { background: #2563eb; color: white; transform: rotate(-45deg); }
.mic-active { color: red; }
</style>
</head>

<body>

<div id="avatar-stage">
    <canvas id="avatar-canvas"></canvas>
    <div id="avatar-status">IN ASCOLTO</div>
</div>

<div id="chat-container">
    <div class="message ai-msg">
        Ciao! üëã Sono NAIA. Sono qui per darti tutte le informazioni sull'Istituto Boccardi-Tiberio. Dimmi pure!
    </div>
</div>

<div id="input-zone">
    <div class="input-wrapper">
        <button id="btn-mic" class="icon-btn" onclick="startDictation()">üéôÔ∏è</button>
        <input id="chat-input" placeholder="Parla con NAIA..." autocomplete="off">
        <button id="btn-send" class="icon-btn" onclick="sendToBrain()">‚û§</button>
    </div>
</div>

<script>
/* ===================== AVATAR 3D ===================== */
let scene, camera, renderer, avatar, mouthMesh;
let lipSyncInterval = null;

function initAvatar() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(35, window.innerWidth/window.innerHeight, 0.1, 100);
    camera.position.set(0, 1.6, 1.8);

    renderer = new THREE.WebGLRenderer({
        canvas: document.getElementById('avatar-canvas'),
        alpha: true,
        antialias: true
    });

    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);

    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const light = new THREE.DirectionalLight(0xffffff, 1.2);
    light.position.set(1,2,3);
    scene.add(light);

    const loader = new THREE.GLTFLoader();
    loader.load(
        'https://models.readyplayer.me/697fa9a97091d5aa566145fb.glb',
        gltf => {
            avatar = gltf.scene;
            avatar.scale.set(1.1,1.1,1.1);
            scene.add(avatar);

            avatar.traverse(o=>{
                if(o.isMesh && o.morphTargetDictionary?.mouthOpen!==undefined){
                    mouthMesh = o;
                }
            });
        }
    );

    animate();
}

function animate() {
    requestAnimationFrame(animate);
    if (avatar) avatar.rotation.y = Math.sin(Date.now()*0.0005)*0.1;
    renderer.render(scene,camera);
}

function startLipSync(){
    if(!mouthMesh) return;
    lipSyncInterval = setInterval(()=>{
        mouthMesh.morphTargetInfluences[
            mouthMesh.morphTargetDictionary.mouthOpen
        ] = Math.random()*0.7;
    },80);
}

function stopLipSync(){
    if(lipSyncInterval) clearInterval(lipSyncInterval);
    if(mouthMesh){
        mouthMesh.morphTargetInfluences[
            mouthMesh.morphTargetDictionary.mouthOpen
        ] = 0;
    }
}

initAvatar();

/* ===================== CHAT + VOCE ===================== */
const synth = window.speechSynthesis;
const chat = document.getElementById('chat-container');
const statusDiv = document.getElementById('avatar-status');

function appendMessage(text, sender){
    const d = document.createElement('div');
    d.className = `message ${sender}-msg`;
    d.innerText = text;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
}

function speak(text){
    if(synth.speaking) synth.cancel();

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'it-IT';
    utterance.rate = 0.9;

    utterance.onstart = ()=>{
        statusDiv.innerText="NAIA PARLA...";
        startLipSync();
    };
    utterance.onend = ()=>{
        stopLipSync();
        statusDiv.innerText="IN ASCOLTO";
    };

    synth.speak(utterance);
}

/* ===================== STT ===================== */
function startDictation(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ alert("Usa Chrome"); return; }
    const r = new SR();
    r.lang='it-IT';
    r.start();
    document.getElementById('btn-mic').classList.add('mic-active');
    r.onresult=e=>{
        document.getElementById('chat-input').value=e.results[0][0].transcript;
    };
    r.onend=()=>{
        document.getElementById('btn-mic').classList.remove('mic-active');
        if(document.getElementById('chat-input').value) sendToBrain();
    };
}

/* ===================== OLLAMA + CERVELLO ===================== */
const OLLAMA_HOST = 'https://kandra-superpious-kanesha.ngrok-free.dev';
const MODEL_NAME = 'naia_school';

async function sendToBrain(){
    const input = document.getElementById('chat-input');
    const question = input.value;
    if(!question) return;

    appendMessage(question,'user');
    input.value='';
    statusDiv.innerText="ELABORAZIONE...";

    const SYSTEM_INSTRUCTION = `
REGOLE FONDAMENTALI (OBBLIGATORIE):
1. Tu sei NAIA, l'Intelligenza Artificiale avanzata dell'istituto Giovanni Boccardi / Ugo Tiberio di Termoli.
2. Rispondi sempre in ITALIANO.
3. VIETATO USARE FORMATTAZIONE VISIVA: NIENTE ASTERISCHI (*), niente elenchi puntati complessi.
4. Sii BREVE e concisa (massimo 3 frasi).
5. Usa un tono professionale ma amichevole.
6. USA SOLO I DATI SCRITTI IN QUESTA SEZIONE.

SCHEDA INFORMATIVA SCUOLA:
1. DATI IDENTIFICATIVI
Istituto di Istruzione Superiore Giovanni Boccardi / Ugo Tiberio.
Indirizzo: Via Alcide De Gasperi, 30, 86039 Termoli (CB).
Email: CBIS01800L@istruzione.it, PEC: CBIS01800L@pec.istruzione.it
Sito Web: www.iisboccarditiberio.edu.it
Telefono: 0875 83655.

2. STORIA
L'istituto nasce dalla fusione del "Giovanni Boccardi" (ex Ragioneria) e dell'"Ugo Tiberio" (ex Nautico e Geometri).
Il Nautico ha certificazione ISO 9001 (TUV SUD), fondamentale per titoli marittimi.

3. OFFERTA FORMATIVA (INDIRIZZI)
SETTORE TECNOLOGICO (Tiberio):
- CAIM (Macchinisti): Conduzione Apparati e Impianti Marittimi.
- CMN (Capitani): Conduzione del Mezzo Navale.
- Logistica: Gestione trasporti.
- CAT (ex Geometri): Costruzioni, Ambiente e Territorio.
SETTORE ECONOMICO (Boccardi):
- AFM: Amministrazione, Finanza e Marketing.
- SIA: Sistemi Informativi Aziendali (Informatica gestionale).
- RIM: Relazioni Internazionali (3 lingue straniere).
- Turismo: Arte, territorio, lingue.
CORSI SERALI: Disponibili per istruzione adulti.

4. QUADRO ORARIO (SINTESI)
CAIM (Macchine): Meccanica e Macchine (5 ore/8 ore in 5¬∞), Elettrotecnica.
CMN (Coperta): Scienze della Navigazione (5 ore/8 ore in 5¬∞).
Materie comuni: Italiano, Storia, Inglese, Matematica, Diritto.

5. LABORATORI E STRUTTURE
Planetario (Progetto "Oltre l'Infinito"), Simulatore Navale professionale.
Sala Voga, Laboratori Informatici (Economy 2.0, SIA), Chimica, Fisica.
Stampanti 3D, Droni, Palestra interna, Campetti esterni, Due Aule Magne.

6. PROGETTI
Erasmus+ (viaggi studio), PCTO (ex Alternanza), Certificazioni Cambridge/DELF/DELE.
Centro Sportivo Scolastico.

7. ORGANIGRAMMA
Dirigente Scolastico: Prof.ssa Concetta Cimmino (Riceve Mar, Mer, Ven 11:00-13:00).
Referente Economico: Prof. Tommaso Guerrera.
Referente Tecnologico: Prof.ssa Barbara Mammarella.
Segreteria: Lun-Sab, ore 11:00 - 13:00.

8. FAQ
- Iscrizioni: Online portale "Unica" (Gennaio/Febbraio). Codice: CBIS01800L.
- Voti: Registro Elettronico Spaggiari.
- Pagamenti: Solo tramite PagoPA.
- Convitto: Non presente interno, solo strutture private esterne.

Domanda dell'utente: ${question}
            
`;

    const res = await fetch(`${OLLAMA_HOST}/api/generate`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
            model:MODEL_NAME,
            prompt: question,
            system: SYSTEM_INSTRUCTION,
            stream:false
        })
    });

    const data = await res.json();
    let cleanText = data.response.replace(/\*/g,"").replace(/\n/g," ");
    appendMessage(cleanText,'ai');
    speak(cleanText);
}

document.getElementById('chat-input').addEventListener('keypress',e=>{
    if(e.key==='Enter') sendToBrain();
});
</script>

</body>
</html>


