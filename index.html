<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NAIA 3D</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: #f4f7f6;
    overflow: hidden;
}

#app-frame {
    display: flex;
    flex-direction: column;
    height: 100vh;
}

header {
    background: white;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    z-index: 10;
}

h1 {
    margin: 0;
    font-size: 18px;
}

#status {
    font-size: 12px;
    color: #2563eb;
    text-transform: uppercase;
}

#scene-container {
    flex: 1;
    background: radial-gradient(circle at top, #ffffff, #e5e7eb);
}

#chat-container {
    padding: 15px;
    height: 30vh;
    overflow-y: auto;
    background: rgba(255,255,255,0.95);
}

.message {
    max-width: 800px;
    margin-bottom: 10px;
    padding: 12px 18px;
    border-radius: 16px;
    font-size: 15px;
}

.ai-msg {
    background: #ffffff;
    border: 1px solid #e5e7eb;
}

.user-msg {
    background: #2563eb;
    color: white;
    margin-left: auto;
}

#input-zone {
    display: flex;
    padding: 10px;
    background: white;
    border-top: 1px solid #e5e7eb;
}

#chat-input {
    flex: 1;
    border-radius: 30px;
    padding: 14px 20px;
    border: none;
    background: #f3f4f6;
    font-size: 15px;
}

#btn-send {
    margin-left: 10px;
    border-radius: 50%;
    width: 50px;
    border: none;
    background: #2563eb;
    color: white;
    font-size: 18px;
    cursor: pointer;
}
</style>
</head>

<body>

<div id="app-frame">
<header>
    <h1>NAIA – School Assistant</h1>
    <div id="status">IN ASCOLTO</div>
</header>

<div id="scene-container"></div>

<div id="chat-container">
    <div class="message ai-msg">
        Ciao! Sono NAIA. Sono qui per darti informazioni sull’Istituto Boccardi-Tiberio.
    </div>
</div>

<div id="input-zone">
    <input id="chat-input" placeholder="Scrivi un messaggio a NAIA…">
    <button id="btn-send" onclick="sendToBrain()">➤</button>
</div>
</div>

<!-- THREE.JS -->
<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.158/examples/js/loaders/GLTFLoader.js"></script>

<script>
/* ===============================
   SCENA 3D – AVATAR PROTAGONISTA
================================ */

let scene, camera, renderer, avatar, mouthMesh;

const container = document.getElementById("scene-container");

scene = new THREE.Scene();

camera = new THREE.PerspectiveCamera(
    35,
    container.clientWidth / container.clientHeight,
    0.1,
    100
);
camera.position.set(0, 1.6, 2.5);

renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(container.clientWidth, container.clientHeight);
renderer.setPixelRatio(window.devicePixelRatio);
container.appendChild(renderer.domElement);

const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
scene.add(light);

const loader = new THREE.GLTFLoader();
loader.load(
    "https://models.readyplayer.me/697fa9a97091d5aa566145fb.glb",
    gltf => {
        avatar = gltf.scene;
        avatar.scale.set(1,1,1);
        scene.add(avatar);

        avatar.traverse(obj => {
            if (obj.morphTargetDictionary && obj.morphTargetDictionary["mouthOpen"]) {
                mouthMesh = obj;
            }
        });
    }
);

function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
}
animate();

window.addEventListener("resize", () => {
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
});

/* ===============================
   CHAT + OLLAMA (CERVELLO INALTERATO)
================================ */

const OLLAMA_HOST = "https://kandra-superpious-kanesha.ngrok-free.dev";
const MODEL_NAME = "naia_school";
const synth = window.speechSynthesis;
const statusDiv = document.getElementById("status");
const chatContainer = document.getElementById("chat-container");

function appendMessage(text, sender) {
    const div = document.createElement("div");
    div.className = "message " + (sender === "user" ? "user-msg" : "ai-msg");
    div.innerText = text;
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

/* ===============================
   SPEECH + LIPSYNC
================================ */

function speak(text) {
    if (synth.speaking) synth.cancel();

    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "it-IT";
    utter.rate = 0.9;

    utter.onstart = () => {
        statusDiv.innerText = "NAIA PARLA...";
        startLipSync();
    };

    utter.onend = () => {
        statusDiv.innerText = "IN ASCOLTO";
        stopLipSync();
    };

    synth.speak(utter);
}

let lipInterval = null;

function startLipSync() {
    if (!mouthMesh) return;
    lipInterval = setInterval(() => {
        mouthMesh.morphTargetInfluences[0] = Math.random() * 0.6;
    }, 80);
}

function stopLipSync() {
    if (lipInterval) clearInterval(lipInterval);
    if (mouthMesh) mouthMesh.morphTargetInfluences[0] = 0;
}

/* ===============================
   INVIO A OLLAMA
================================ */

async function sendToBrain() {
    const input = document.getElementById("chat-input");
    const question = input.value.trim();
    if (!question) return;

    appendMessage(question, "user");
    input.value = "";
    statusDiv.innerText = "ELABORAZIONE...";

    const SYSTEM_INSTRUCTION = `   
REGOLE FONDAMENTALI (OBBLIGATORIE):
1. Tu sei NAIA, l'Intelligenza Artificiale avanzata dell'istituto Giovanni Boccardi / Ugo Tiberio di Termoli.
2. Rispondi sempre in ITALIANO.
3. VIETATO USARE FORMATTAZIONE VISIVA: NIENTE ASTERISCHI (*), niente elenchi puntati complessi.
4. Sii BREVE e concisa (massimo 3 frasi).
5. Usa un tono professionale ma amichevole.
6. USA SOLO I DATI SCRITTI IN QUESTA SEZIONE.

SCHEDA INFORMATIVA SCUOLA:
1. DATI IDENTIFICATIVI
Istituto di Istruzione Superiore Giovanni Boccardi / Ugo Tiberio.
Indirizzo: Via Alcide De Gasperi, 30, 86039 Termoli (CB).
Email: CBIS01800L@istruzione.it, PEC: CBIS01800L@pec.istruzione.it
Sito Web: www.iisboccarditiberio.edu.it
Telefono: 0875 83655.

2. STORIA
L'istituto nasce dalla fusione del "Giovanni Boccardi" (ex Ragioneria) e dell'"Ugo Tiberio" (ex Nautico e Geometri).
Il Nautico ha certificazione ISO 9001 (TUV SUD), fondamentale per titoli marittimi.

3. OFFERTA FORMATIVA (INDIRIZZI)
SETTORE TECNOLOGICO (Tiberio):
- CAIM (Macchinisti): Conduzione Apparati e Impianti Marittimi.
- CMN (Capitani): Conduzione del Mezzo Navale.
- Logistica: Gestione trasporti.
- CAT (ex Geometri): Costruzioni, Ambiente e Territorio.
SETTORE ECONOMICO (Boccardi):
- AFM: Amministrazione, Finanza e Marketing.
- SIA: Sistemi Informativi Aziendali (Informatica gestionale).
- RIM: Relazioni Internazionali (3 lingue straniere).
- Turismo: Arte, territorio, lingue.
CORSI SERALI: Disponibili per istruzione adulti.

4. QUADRO ORARIO (SINTESI)
CAIM (Macchine): Meccanica e Macchine (5 ore/8 ore in 5°), Elettrotecnica.
CMN (Coperta): Scienze della Navigazione (5 ore/8 ore in 5°).
Materie comuni: Italiano, Storia, Inglese, Matematica, Diritto.

5. LABORATORI E STRUTTURE
Planetario (Progetto "Oltre l'Infinito"), Simulatore Navale professionale.
Sala Voga, Laboratori Informatici (Economy 2.0, SIA), Chimica, Fisica.
Stampanti 3D, Droni, Palestra interna, Campetti esterni, Due Aule Magne.

6. PROGETTI
Erasmus+ (viaggi studio), PCTO (ex Alternanza), Certificazioni Cambridge/DELF/DELE.
Centro Sportivo Scolastico.

7. ORGANIGRAMMA
Dirigente Scolastico: Prof.ssa Concetta Cimmino (Riceve Mar, Mer, Ven 11:00-13:00).
Referente Economico: Prof. Tommaso Guerrera.
Referente Tecnologico: Prof.ssa Barbara Mammarella.
Segreteria: Lun-Sab, ore 11:00 - 13:00.

8. FAQ
- Iscrizioni: Online portale "Unica" (Gennaio/Febbraio). Codice: CBIS01800L.
- Voti: Registro Elettronico Spaggiari.
- Pagamenti: Solo tramite PagoPA.
- Convitto: Non presente interno, solo strutture private esterne.

Domanda dell'utente: ${question}
            
`;

    try {
        const response = await fetch(`${OLLAMA_HOST}/api/generate`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                model: MODEL_NAME,
                prompt: question,
                system: SYSTEM_INSTRUCTION,
                stream: false
            })
        });

        const data = await response.json();
        const text = data.response.replace(/\*/g, "").replace(/\n+/g, " ");

        appendMessage(text, "ai");
        speak(text);

    } catch (e) {
        statusDiv.innerText = "ERRORE";
        console.error(e);
    }
}

document.getElementById("chat-input")
.addEventListener("keypress", e => {
    if (e.key === "Enter") sendToBrain();
});
</script>

</body>
</html>



