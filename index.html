<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NAIA - 3D Full Prompt</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
            "talkinghead": "https://cdn.jsdelivr.net/gh/met4citizen/TalkingHead@1.1/modules/talkinghead.mjs"
        }
    }
    </script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; background-color: #f4f7f6; height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }

        /* ZONA AVATAR (Parte Alta) */
        #avatar-view { width: 100%; height: 45vh; position: relative; background: radial-gradient(circle, #e0e0e0 0%, #ffffff 100%); border-bottom: 1px solid #ccc; z-index: 1; }
        #avatar-container { width: 100%; height: 100%; display: block; }

        /* OVERLAY DI CARICAMENTO */
        #loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; padding: 20px; text-align: center; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #start-btn { display: none; margin-top: 20px; padding: 12px 25px; background: #2563eb; color: white; border: none; border-radius: 30px; font-size: 16px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }

        /* CHAT (Parte Centrale) */
        #chat-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; background: #fff; }
        .message { max-width: 85%; padding: 14px 20px; border-radius: 20px; font-size: 15px; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); animation: popIn 0.3s ease; }
        .ai-msg { align-self: flex-start; background: #f0f2f5; color: #333; border: 1px solid #e0e0e0; border-bottom-left-radius: 4px; }
        .user-msg { align-self: flex-end; background: #2563eb; color: white; border-bottom-right-radius: 4px; }

        /* INPUT E CONTROLLI (Parte Bassa) */
        #input-zone { padding: 15px 20px; background: white; border-top: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        #chat-input { flex: 1; background: #f3f4f6; border: none; padding: 15px 20px; border-radius: 30px; font-size: 16px; outline: none; }
        .icon-btn { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; background: white; border: 1px solid #ddd; color: #555; }
        #btn-send { background: #2563eb; color: white; border: none; }
        .mic-active { color: #ef4444 !important; border-color: #ef4444 !important; animation: pulseRed 1.5s infinite; }
        
        #suggestions { padding: 10px 15px; display: flex; gap: 10px; overflow-x: auto; background: #fafafa; border-top: 1px solid #eee; }
        .chip { background: white; border: 1px solid #2563eb; color: #2563eb; padding: 8px 15px; border-radius: 20px; font-size: 13px; white-space: nowrap; cursor: pointer; }
        
        @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body>

    <div id="avatar-view">
        <div id="loading-overlay">
            <div class="loader" id="spinner"></div>
            <div id="load-text">Caricamento NAIA 3D...</div>
            <button id="start-btn" onclick="startExperience()">TOCCA PER INIZIARE</button>
        </div>
        <div id="avatar-container"></div>
    </div>

    <div id="chat-container"></div>

    <div id="suggestions">
        <div class="chip" onclick="quickAsk('Quali sono gli indirizzi?')">üìö Indirizzi</div>
        <div class="chip" onclick="quickAsk('Chi √® la preside?')">üéì Preside</div>
        <div class="chip" onclick="quickAsk('Dove si trova?')">üìç Posizione</div>
    </div>

    <div id="input-zone">
        <button id="btn-mic" class="icon-btn" onclick="startDictation()">üéôÔ∏è</button>
        <input type="text" id="chat-input" placeholder="Scrivi qui..." autocomplete="off">
        <button id="btn-send" class="icon-btn" onclick="sendToBrain()">‚û§</button>
    </div>

    <script type="module">
        import { TalkingHead } from "talkinghead";

        // CONFIGURAZIONE
        const OLLAMA_HOST = 'https://kandra-superpious-kanesha.ngrok-free.dev'; 
        const MODEL_NAME = "naia_school"; 
        const AVATAR_URL = "https://models.readyplayer.me/697fa9a97091d5aa566145fb.glb?morphTargets=ARKit&textureAtlas=1024";

        const chatContainer = document.getElementById('chat-container');
        const inputField = document.getElementById('chat-input');
        const loadingOverlay = document.getElementById('loading-overlay');
        const spinner = document.getElementById('spinner');
        const loadText = document.getElementById('load-text');
        const startBtn = document.getElementById('start-btn');

        let head; 

        // --- 1. FUNZIONE TTS PERSONALIZZATA (SOLUZIONE ERRORE ROSSO) ---
        // Questa funzione sostituisce il TTS di Google che dava errore.
        // Scarica l'audio "Carla" (italiano) da StreamElements e lo passa all'avatar.
        async function customTTS(text) {
            try {
                const url = `https://api.streamelements.com/kappa/v2/speech?voice=Carla&text=${encodeURIComponent(text)}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error("Errore TTS StreamElements");
                const blob = await response.blob();
                return await blob.arrayBuffer(); 
            } catch (error) {
                console.error("TTS Error:", error);
                throw error;
            }
        }

        // --- 2. INIZIALIZZAZIONE AVATAR ---
        async function initAvatar() {
            const nodeAvatar = document.getElementById('avatar-container');
            try {
                // Inizializza TalkingHead usando la nostra funzione customTTS
                head = new TalkingHead(nodeAvatar, {
                    tts: customTTS, 
                    cameraView: "upper",
                    softShadows: true
                });

                // Carica il modello 3D
                await head.showAvatar({
                    url: AVATAR_URL,
                    body: "F",
                    avatarMood: "neutral",
                    lipsyncLang: 'it' 
                });
                
                // Tutto pronto
                spinner.style.display = "none";
                loadText.innerText = "NAIA √® pronta.";
                startBtn.style.display = "block";

            } catch (error) {
                console.error("Init Error:", error);
                spinner.style.display = "none";
                loadText.innerText = "Errore caricamento 3D.";
                // Fallback: mostra un errore in chat ma permette di scrivere
                appendMessage("Errore caricamento grafico. La chat testuale funziona.", 'ai');
                loadingOverlay.style.display = "none"; 
            }
        }

        // --- 3. AVVIO ESPERIENZA ---
        window.startExperience = async function() {
            loadingOverlay.style.display = "none";
            // Sblocca audio context (necessario per i browser moderni)
            if (head && head.audioCtx) {
                await head.audioCtx.resume();
            }
            const welcome = "Ciao! Sono NAIA. Sono qui per aiutarti con informazioni sull'istituto Boccardi Tiberio.";
            appendMessage(welcome, 'ai');
            if(head) head.speakText(welcome);
        };

        window.addEventListener('DOMContentLoaded', initAvatar);


        // --- UTILS ---
        function appendMessage(text, sender) {
            const div = document.createElement('div');
            div.classList.add('message', sender === 'user' ? 'user-msg' : 'ai-msg');
            div.innerHTML = text.replace(/\n/g, "<br>");
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        window.quickAsk = function(text) { inputField.value = text; sendToBrain(); }

        window.startDictation = function() {
            const btn = document.getElementById('btn-mic');
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'it-IT';
            recognition.start();
            recognition.onstart = () => { btn.classList.add("mic-active"); inputField.placeholder = "Ti ascolto..."; };
            recognition.onend = () => { btn.classList.remove("mic-active"); inputField.placeholder = "Scrivi qui..."; if(inputField.value) sendToBrain(); };
            recognition.onresult = (e) => { inputField.value = e.results[0][0].transcript; };
        };

        // --- 4. IL CERVELLO (PROMPT COMPLETO) ---
        window.sendToBrain = async function() {
            const question = inputField.value.trim();
            if (!question) return;

            // Assicurati che l'audio sia attivo
            if (head && head.audioCtx && head.audioCtx.state === 'suspended') head.audioCtx.resume();

            appendMessage(question, 'user');
            inputField.value = "";
            if(head) head.stopSpeaking(); // Ferma se sta parlando

            // ============================================================
            // PROMPT COMPLETO (Recuperato dal tuo file originale)
            // ============================================================
            const SYSTEM_INSTRUCTION = `
REGOLE FONDAMENTALI (OBBLIGATORIE):
1. Tu sei NAIA, l'Intelligenza Artificiale avanzata dell'istituto Giovanni Boccardi / Ugo Tiberio di Termoli.
2. Rispondi sempre in ITALIANO.
3. VIETATO USARE FORMATTAZIONE VISIVA: NIENTE ASTERISCHI (*), niente elenchi puntati, niente grassetti, niente titoli (#).
4. Sii BREVE e concisa (massimo 2-3 frasi se possibile).
5. Usa un tono professionale ma amichevole.
6. USA SOLO I DATI SCRITTI QUI SOTTO.

SCHEDA INFORMATIVA SCUOLA:
1. DATI IDENTIFICATIVI
Istituto Giovanni Boccardi / Ugo Tiberio, Via Alcide De Gasperi 30, Termoli (CB).
Email: CBIS01800L@istruzione.it, Sito: www.iisboccarditiberio.edu.it, Tel: 087583655.
2. STORIA
Fusione di Tecnico Economico "Boccardi" e Tecnico Tecnologico "Tiberio" (Nautico/Geometri).
Il Nautico ha certificazione ISO 9001.
3. INDIRIZZI DI STUDIO
Tecnologico (Tiberio):
- CAIM (Macchinisti navali): Meccanica, macchine (5 ore/8 ore in 5¬∞), laboratorio.
- CMN (Capitani): Scienze navigazione (5 ore/8 ore in 5¬∞), laboratorio.
- Logistica: Trasporti intermodali.
- CAT (Costruzioni Ambiente Territorio - ex Geometri).
Economico (Boccardi):
- AFM (Amministrazione Finanza Marketing).
- SIA (Sistemi Informativi Aziendali): Informatica gestionale, database.
- RIM (Relazioni Internazionali Marketing): 3 lingue straniere.
- Turismo: Arte, territorio, 3 lingue.
Corsi Serali per adulti disponibili.
4. QUADRO ORARIO (Sintesi)
Italiano (4 ore), Storia (2 ore), Inglese (3 ore) per tutti.
Matematica (4 ore biennio, 3 triennio).
Materie specifiche variano per indirizzo (Navigazione, Meccanica, Informatica, ecc.).
5. LABORATORI E STRUTTURE
Planetario (Progetto "Oltre l'Infinito"), Simulatore Navale professionale, Sala Voga.
Laboratori Informatici (Economy 2.0, SIA), Chimica, Fisica, Scienze Navigazione.
Stampanti 3D, Droni, Palestra interna, Campetti esterni, Due Aule Magne.
6. PROGETTI
Erasmus+ (viaggi studio), PCTO (ex Alternanza), Certificazioni Cambridge/DELF/DELE.
Centro Sportivo Scolastico.
7. ORGANIGRAMMA
Dirigente: Prof.ssa Concetta Cimmino (Riceve Mar-Mer-Ven 11-13).
Referente Economico: Prof. Tommaso Guerrera.
Referente Tecnologico: Prof.ssa Barbara Mammarella.
Segreteria: Lun-Sab 11-13.
8. INFO PRATICHE
Iscrizioni: Online portale "Unica" (Gennaio/Febbraio). Codice Tiberio: CBIS01800L.
Voti: Registro Elettronico Spaggiari.
Pagamenti: Solo PagoPA.
Convitto: Non presente interno (solo convenzioni esterne).

Domanda dell'utente: ${question}
            `;

            try {
                const response = await fetch(`${OLLAMA_HOST}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        prompt: question, 
                        system: SYSTEM_INSTRUCTION,
                        stream: false,
                        keep_alive: -1,
                        options: { temperature: 0, num_predict: 450 }
                    })
                });
                
                if (!response.ok) throw new Error("Errore Network");
                const data = await response.json();
                
                // PULIZIA TESTO
                let cleanText = data.response
                    .replace(/\*/g, "")
                    .replace(/[#_`~]/g, "")
                    .replace(/\n/g, " ")
                    .replace(/\s+/g, " ")
                // Gestione siti web per la voce (legge "punto" invece di ignorarlo)
                cleanText = cleanText.replace(/(www\.[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gi, function(match) {
                     return match.replace(/\./g, " punto ");
                });

                appendMessage(cleanText, 'ai');
                
                // PARLA (Usa customTTS automaticamente)
                if(head) {
                    head.speakText(cleanText);
                }

            } catch (error) {
                console.error(error);
                appendMessage("Problema di connessione con il cervello.", 'ai');
            }
        };

        inputField.addEventListener("keypress", (e) => { if (e.key === "Enter") sendToBrain(); });

    </script>
</body>
</html>
