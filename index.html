<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NAIA 3D - FIXED</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
            "talkinghead": "https://cdn.jsdelivr.net/gh/met4citizen/TalkingHead@1.1/modules/talkinghead.mjs"
        }
    }
    </script>

    <style>
        /* RESET E BASE */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: white; height: 100dvh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }

        /* DEBUG BAR - Se non la vedi, stai guardando il file vecchio */
        #debug-bar {
            background: #ef4444; color: white; font-size: 10px; text-align: center; padding: 2px;
            font-weight: bold; width: 100%; z-index: 9999;
        }

        /* AREA AVATAR 3D */
        #avatar-stage {
            height: 45vh; width: 100%;
            background: linear-gradient(135deg, #a78bfa 0%, #3b82f6 100%);
            position: relative; overflow: hidden;
        }
        
        #avatar-container { width: 100%; height: 100%; display: block; }

        /* SCRITTE SOPRA L'AVATAR */
        .top-info { position: absolute; top: 20px; left: 20px; z-index: 10; pointer-events: none; }
        .top-info h1 { margin: 0; font-size: 20px; color: white; text-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .top-info #status { font-size: 11px; color: #e0e7ff; font-weight: 600; margin-top: 2px; }

        /* LOADING & START BUTTON */
        #loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(3px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20;
        }
        .spinner { width: 30px; height: 30px; border: 3px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #start-btn { 
            display: none; padding: 12px 25px; background: white; color: #2563eb; 
            border: none; border-radius: 25px; font-weight: 700; cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 30;
        }

        /* AREA CHAT */
        #chat-container {
            flex: 1; background: white; margin-top: -30px; border-radius: 30px 30px 0 0;
            padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
            z-index: 30; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        }
        .message { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.4; }
        .ai-msg { align-self: flex-start; background: #f3f4f6; color: #1f2937; border-bottom-left-radius: 4px; }
        .user-msg { align-self: flex-end; background: #3b82f6; color: white; border-bottom-right-radius: 4px; }

        /* INPUT AREA */
        #input-area { padding: 15px; background: white; border-top: 1px solid #f3f4f6; padding-bottom: calc(15px + env(safe-area-inset-bottom)); }
        .input-box { background: #f3f4f6; border-radius: 25px; padding: 5px; display: flex; align-items: center; }
        #chat-input { flex: 1; background: transparent; border: none; padding: 10px 15px; outline: none; font-size: 16px; }
        .icon-btn { width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 18px; }
        #btn-mic { background: white; color: #6b7280; }
        .mic-active { color: red !important; animation: pulse 1s infinite; }
        #btn-send { background: #3b82f6; color: white; margin-left: 5px; }
        @keyframes pulse { 50% { opacity: 0.5; } }
        
        /* Error Display */
        #error-log { display: none; color: #ffadad; font-size: 12px; max-width: 80%; text-align: center; margin-top: 10px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 4px;}
    </style>
</head>
<body>

    <div id="debug-bar">DEBUG MODE ATTIVO - Versione 5.0</div>

    <div id="avatar-stage">
        <div class="top-info">
            <h1>NAIA</h1>
            <div id="status">INIZIALIZZAZIONE 3D...</div>
        </div>

        <div id="loading-overlay">
            <div class="spinner" id="loader"></div>
            <div id="error-log"></div>
            <button id="start-btn" onclick="startExperience()">CLICCA PER PARLARE</button>
        </div>

        <div id="avatar-container"></div>
    </div>

    <div id="chat-container">
        </div>

    <div id="input-area">
        <div class="input-box">
            <button id="btn-mic" class="icon-btn" onclick="toggleMic()">üéôÔ∏è</button>
            <input type="text" id="chat-input" placeholder="Chiedi qualcosa..." autocomplete="off">
            <button id="btn-send" class="icon-btn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <script type="module">
        import { TalkingHead } from "talkinghead";

        // --- VARIABILI GLOBALI ---
        const OLLAMA_HOST = 'https://kandra-superpious-kanesha.ngrok-free.dev'; 
        const MODEL_NAME = "naia_school";
        // URL con parametri ARKit necessari per il movimento labbra
        const AVATAR_URL = "https://models.readyplayer.me/697fa9a97091d5aa566145fb.glb?morphTargets=ARKit&lod=1";

        let head; // Istanza avatar
        const chatInput = document.getElementById('chat-input');
        const statusDiv = document.getElementById('status');
        const startBtn = document.getElementById('start-btn');
        const loader = document.getElementById('loader');
        const errorLog = document.getElementById('error-log');

        // --- 1. FUNZIONE VOCE (SOLUZIONE DEFINITIVA) ---
        // Questa funzione scarica l'audio da un server gratuito e lo passa all'avatar per il lip-sync
        async function freeTTS(text) {
            try {
                // Usiamo StreamElements (voce Carla Italiano)
                const safeText = encodeURIComponent(text);
                const url = `https://api.streamelements.com/kappa/v2/speech?voice=Carla&text=${safeText}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error("Errore TTS Server");
                
                const blob = await response.blob();
                return await blob.arrayBuffer(); // Ritorna l'audio grezzo
            } catch (error) {
                console.error("TTS Error:", error);
                // Fallback silenzioso per non bloccare tutto
                return new ArrayBuffer(0);
            }
        }

        // --- 2. CARICAMENTO AVATAR ---
        async function init() {
            try {
                const node = document.getElementById('avatar-container');
                
                // Configurazione TalkingHead SENZA API Key Google
                head = new TalkingHead(node, {
                    tts: freeTTS, // Assegniamo la nostra funzione custom
                    cameraView: "upper", // Inquadratura busto
                    cameraDistance: 1.7
                });

                // Carica il modello
                await head.showAvatar({
                    url: AVATAR_URL,
                    body: "F",
                    avatarMood: "neutral",
                    lipsyncLang: 'it'
                });

                // Se arriviamo qui, ha funzionato
                loader.style.display = 'none';
                startBtn.style.display = 'block';
                statusDiv.innerText = "PRONTA (Clicca Start)";

            } catch (err) {
                console.error("Errore Init:", err);
                loader.style.display = 'none';
                errorLog.style.display = 'block';
                errorLog.innerText = "ERRORE: " + err.message;
                statusDiv.innerText = "ERRORE CARICAMENTO";
            }
        }

        // --- 3. START (Necessario per l'audio) ---
        window.startExperience = async function() {
            document.getElementById('loading-overlay').style.display = 'none';
            try {
                // Sblocca il contesto audio del browser
                if (head) {
                    head.start();
                    const welcome = "Ciao! Sono NAIA. Sono pronta.";
                    addMessage(welcome, 'ai');
                    head.speakText(welcome);
                    statusDiv.innerText = "ONLINE";
                }
            } catch (e) {
                console.log("Audio start error:", e);
            }
        }

        // --- 4. CERVELLO (Ollama) ---
        window.sendMessage = async function() {
            const text = chatInput.value.trim();
            if (!text) return;

            // Stop voce precedente
            if(head) head.stopSpeaking();

            addMessage(text, 'user');
            chatInput.value = "";
            statusDiv.innerText = "ELABORAZIONE...";
            // --- INIZIO SYSTEM PROMPT ---
            const SYSTEM_INSTRUCTION = `
REGOLE FONDAMENTALI (OBBLIGATORIE):
1. Tu sei NAIA, l'Intelligenza Artificiale avanzata dell'istituto Giovanni Boccardi / Ugo Tiberio di Termoli, DEVI RISPONDERE ESATTAMENTE COSI LA PRIMA VOLTA CHE TI VIENE POSTA UNA DOMANDA.
2. Rispondi sempre in ITALIANO.
3. VIETATO USARE FORMATTAZIONE VISIVA: NIENTE ASTERISCHI (*), niente elenchi puntati, niente grassetti, niente titoli (#).
4. Sii BREVE e concisa (massimo 2 frasi).
5. Usa un tono professionale ma amichevole, un po' futuristico.
6. Se non sai una cosa, di' semplicemente che stai ancora imparando.
7. Non inventare fatti strani.
8. SOLO Se ti chiedono "Chi sei", DEVI rispondere che ti chiami NAIA e che sei l'AI della scuola Giovanni Boccardi / Ugo Tiberio di Termoli.
9. DOPO ESSERTI PRESENTATA LA PRIMA VOLTA NON INIZIARE MAI una risposta dicendo "Sono NAIA", rispondi semplicemente alla domanda, vai dritta al punto.
10. NON usare elenchi puntati complessi, USA FRASI DISCORSIVE.
11. USA SOLO I DATI SCRITTI IN QUESTA SEZIONE.
I tuo compito √® accogliere gli ospiti e rispondere alle domande sulla scuola.
SCHEDA INFORMATIVA SCUOLA:
1. DATI IDENTIFICATIVI E AMMINISTRATIVI
denominazione Ufficiale, Istituto di Istruzione Superiore Giovanni Boccardi / Ugo Tiberio,
- via o indirizzo della sede Centrale, √® Via Alcide De Gasperi, 30, 86 0 39, Termoli (C B), Molise..
- pec (Posta Certificata): CBIS01800L@pec.istruzione.it..
- email: Istituzionale CBIS01800L@istruzione.it..
- sito Web: www.iisboccarditiberio.edu.it..
- telefono: 0 8 7 5 8 3 6 5 5..
- segreteria aperta al pubblico da Lunedi a sabato, ore 11:00 - 13:00..
2. STORIA E IDENTIT√Ä
l'istituto nasce dalla fusione di due storiche scuole di Termoli, l'Istituto Tecnico Economico "Giovanni Boccardi" (ex Ragioneria, fondato nel 1959) e l'Istituto Tecnico Tecnologico "Ugo Tiberio" (ex Nautico e Geometri)..
L'indirizzo Trasporti e Logistica (Nautico) vanta la Certificazione di Qualit√† ISO 9001 rilasciata da TUV SUD (Certificato n¬∞ 5010014484), fondamentale per il riconoscimento dei titoli marittimi internazionali
3. OFFERTA FORMATIVA DETTAGLIATA
l'istituto offre percorsi diurni (5 anni) e percorsi serali (istruzione per adulti)
per il settore tecnologico Ugo Tiberio abbiamo a disposizione i seguenti corsi di studio:
indirizzo c a i m, Conduzione Apparati e Impianti Marittimi: Formazione per Ufficiali di Macchina..
indirizzo c m n, Conduzione del Mezzo Navale: Formazione per Ufficiali di Coperta (Capitani)..
indirizzo logistica, Gestione dei trasporti intermodali terra, mare e aria..
indirizzo c a t, Costruzioni, Ambiente e Territorio - ex Geometri: Progettazione edilizia, topografia, estimo, sicurezza cantieri, riqualificazione energetica..
per il settore economico Giovanni Boccardi abbiamo a disposizione i seguenti corsi di studio:
indirizzo a f m, Amministrazione, Finanza e Marketing: Il corso "classico". Competenze gestionali, fiscali e amministrative..
indirizzi s i a, Sistemi Informativi Aziendale: Curvatura informatica dell'AFM (dal 3¬∞ anno). Si studia informatica gestionale, database, coding applicato all'economia..
indirizzo r i m, Relazioni Internazionali per il Marketing: Curvatura linguistica dell'AFM (dal 3¬∞ anno). Studio di tre lingue straniere, geopolitica e relazioni internazionali..
indirizzo turismo, Percorso specifico per l'impresa turistica. Materie caratterizzanti: Discipline turistiche e aziendali, Arte e Territorio, tre lingue straniere..
corsi SERALI Istruzione per Adulti..
percorsi abbreviati per lavoratori o chi vuole riprendere gli studi, attivi sia per l'indirizzo Economico che per il Tecnologico, in base al numero di iscritti..
4. QUADRO ORARIO DISCIPLINE
1 Opzione caim ufficiali di macchina:
italiano 4 ore settimanali per l'intera durata del percorso di studi..
storia 2 ore settimanali per l'intera durata del percorso di studi..
inglese 3 ore settimanali per l'intera durata del percorso di studi..
matematica 4 ore nel biennio per poi passare a 3 ore negli ultimi 3 anni..
diritto ed Economia 2 ore per l'intera durata del percorso di studi..
logistica 3 ore di cui 1 in laboratorio per il terzo e quarto anno..
elettrotecnica e Automazione 3 ore di cui 2 di laboratorio per gli ultimi 3 anni..
scienze della navigazione 3 ore (2 di laboratorio) terzo e quarto anno, 4 ore (3 di laboratorio) il quinto anno..
meccanica e Macchine 5 ore per il terzo e il quarto di cui 3 di laboratorio, 8 ore al quinto di cui 5 di laboratorio..
scienze motorie 2 ore per tutti gli anni di corso.. 
religione 1 ora per tutti gli anni di corso.. 
informatica, Tecniche di rappresentazione grafica, geografia e scienze applicate si fanno nel primo e nel secondo anno.. 
2 Opzione cmn ufficiali di coperta:
italiano 4 ore settimanali per l'intera durata del percorso di studi.. 
storia 2 ore settimanali per l'intera durata del percorso di studi..
inglese 3 ore settimanali per l'intera durata del percorso di studi.. 
matematica 4 ore nel biennio per poi passare a 3 ore negli ultimi 3 anni.. 
diritto ed Economia 2 ore per l'intera durata del percorso di studi.. 
logistica 3 ore di cui 1 in laboratorio per il terzo e quarto anno.. 
elettrotecnica e Automazione 3 ore di cui 2 di laboratorio per gli ultimi 3 anni.. 
meccanica e Macchine 3 ore (2 di laboratorio) terzo e quarto anno, 4 ore (3 di laboratorio) il quinto anno.. 
scienze della navigazione 5 ore per il terzo e il quarto di cui 3 di laboratorio, 8 ore al quinto di cui 5 di laboratorio.. 
scienze motorie 2 ore per tutti gli anni di corso.. 
religione 1 ora per tutti gli anni di corso.. 
informatica, chimica, fisica, biologia e scienze applicate si fanno nel primo e nel secondo anno.. 
5. STRUTTURE, LABORATORI E DOTAZIONI TECNICHE
se l'utente chiede "perch√© scegliere questa scuola" o "che laboratori avete", cita questi asset specifici:
planetario, Ristrutturato e riattivato (progetto "Oltre l'Infinito"), utilizzato per lezioni di astronomia e navigazione..
simulatore Navale, Software e hardware professionale per la simulazione di manovre navali (fondamentale per il Nautico)..
sala Voga, Ambiente attrezzato per la preparazione fisica al canottaggio..
laboratori Informatici, 5 aule informatizzate (Lab. Economy 2.0, Informatica SIA, Informatica Base).. 
altri Laboratori, Chimica, Fisica, Scienze della Navigazione, Logistica.. 
digital Fabrication, Stampanti 3D e Droni professionali per rilievi topografici e sottomarini.. 
strutture Sportive, Palestra interna, sala attrezzi ginnici, tavoli da ping-pong, campetti esterni.. 
sale Conferenze, Due aule magne per eventi e assemblee.. 
6. PROGETTI E OPPORTUNIT√Ä (EXTRA-CURRICULARI)
erasmus+ (Accreditamento 2022-2027): La scuola √® accreditata come polo di eccellenza per la mobilit√† europea, offre viaggi studio gratuiti e stage all'estero per studenti e docenti..
F S L (ex Alternanza Scuola-Lavoro): Collaborazioni con aziende del territorio, studi professionali, compagnie di navigazione, enti turistici e banche per tirocini formativi..
certificazioni Linguistiche: Preparazione per Cambridge (Inglese), DELF (Francese), DELE (Spagnolo)..
centro Sportivo Scolastico: Attivit√† pomeridiane (es. canottaggio, sport di squadra)..
7. ORGANIGRAMMA E ORARI DI RICEVIMENTO
dirigente Scolastico √® la professoressa Concetta Cimmino, ricevimento Marted√¨, Mercoled√¨, Venerd√¨ (11:00-13:00) su appuntamento..
collaboratori del Dirigente 
il referente per il settore economico lato Boccardi √® il professore Tommaso Guerrera
la referente per il settore tecnologico lato tiberio e la professoressa Barbara Mammarella
8. DOMANDE FREQUENTI (FAQ) - ISTRUZIONI DI RISPOSTA
Q: Come vedo i voti di mio figlio?
A: Utilizza il Registro Elettronico Spaggiari. Le credenziali vengono fornite dalla segreteria al primo anno. C'√® un link diretto sul sito web della scuola
Q: La scuola √® aperta il pomeriggio?
A: Gli uffici di segreteria no (chiudono alle 14:00, salvo aperture straordinarie). La scuola rimane aperta per i corsi serali e per i progetti pomeridiani programmati
Q: Cosa devo fare per l'iscrizione al primo anno?
A: L'iscrizione si fa online tramite il portale Ministeriale "Unica" (gennaio/febbraio). Ti servir√† il codice meccanografico specifico dell'indirizzo scelto (vedi sezione 1 dei miei dati)
Q: Qual √® il codice meccanografico dell'istituto U Tiberio?
A: CBIS01800L
Q: C'√® il convitto?
A: Non risulta presente un convitto interno gestito direttamente dalla scuola. Gli studenti fuori sede solitamente si appoggiano a strutture private o convitti convenzionati nella zona di Termoli (verificare disponibilit√† aggiornata in segreteria)
Q: Accettate pagamenti in contanti?
A: No. Tutti i pagamenti verso la scuola (tasse, gite, assicurazione) devono passare obbligatoriamente tramite il sistema PagoPA

            Domanda dell'utente: ${question}
           `;
            // --- FINE SYSTEM PROMPT ---

            statusDiv.innerText = "ELABORAZIONE...";
            inputField.value = "";

            try {
                const response = await fetch(`${OLLAMA_HOST}/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        prompt: question, 
                        system: SYSTEM_INSTRUCTION,
                        stream: false,
                        keep_alive: -1,
                        options: {
                            temperature: 0,
                            num_predict: 600,
                            seed: 123,      
                            num_ctx: 4096   
                        }
                    })
                });
                
                if (!response.ok) throw new Error("Errore Network");
                const data = await response.json();
                
                let rawText = data.response;
                let cleanText = rawText.replace(/\*/g, ""); 
                cleanText = cleanText.replace(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gi, function(match) {
                    return match.replace(/@/g, " chiocciola ").replace(/\./g, " punto ");
                });
                cleanText = cleanText.replace(/(www\.[a-zA-Z0-9._-]+\.[a-zA-Z0-9_-]+)/gi, function(match) {
                     return match.replace(/\./g, " punto ");
                });
                cleanText = cleanText.replace(/\n\n/g, ". ");
                cleanText = cleanText.replace(/\n/g, " ");
                cleanText = cleanText.replace(/\s+/g, " "); 
                cleanText = cleanText.replace(/\.\s*\./g, "."); 

                appendMessage(cleanText, 'ai');
                statusDiv.innerText = "ATTIVA";
                
                // PARLA E ANIMA
                if (head) {
                    head.speakText(cleanText);
                }
                
                img.style.filter = "none";
                speak(cleanText);

            } catch (error) {
                console.error(error);
                img.style.filter = "none";
                statusDiv.innerText = "ERRORE DI RETE";
                alert("Errore di connessione. Controlla Ngrok!");
            }
        }
        
        document.getElementById("chat-input").addEventListener("keypress", (e) => { if (e.key === "Enter") sendToBrain(); });
        function quickAsk(text) {
            document.getElementById('chat-input').value = text;
            sendToBrain();
        }
    </script>
</body>
</html>
























